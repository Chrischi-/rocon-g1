var fs=require("fs"),logger=require("./config/logger"),path=require("path");logger.transports.file.level="info";var newRoconDir="/var/local/rocon-g1.tmp",oldRoconDir="/var/local/rocon-g1";logger.info("old version directory:",oldRoconDir,", new version directory:",newRoconDir);var newVersion=parseInt(fs.readFileSync(path.join(newRoconDir,"/version"))),oldVersion=parseInt(fs.readFileSync(path.join(oldRoconDir,"/version")));isNaN(oldVersion)&&(oldVersion=27),logger.info("migrating version",oldVersion,"to",newVersion);var handleError=function(a){throw logger.error("Error occurred during migration:",a),a},migrate=function(a,b){if(a>newVersion)logger.info("migration done"),b(null);else{var c=newRoconDir+"/migrations/"+a;if(fs.existsSync(c)){logger.info("migrating to version",a,"loading from directory",c);var d=require(c);d(function(c){c?(logger.error("Error occurred during migration",a,"Error:",c),b(c)):(logger.info("Migration successfully done"),migrate(++a,b))})}else migrate(++a,b)}};migrate(oldVersion+1,function(a){a&&handleError(a),logger.info("Changing mode for /updater/clean.sh"),fs.chmodSync(path.join(newRoconDir,"/updater/clean.sh"),"770"),logger.info("Changing mode for /updater/run.sh"),fs.chmodSync(path.join(newRoconDir,"/updater/run.sh"),"770"),logger.info("Migration finished.")});