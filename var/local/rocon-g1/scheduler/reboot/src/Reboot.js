var _=require("underscore"),fs=require("fs"),moment=require("moment"),https=require("https"),exec=require("child_process").exec,rebootSchedulerSettings=require("../../../config/settings.json"),config=require("../../../config/config"),logger=require("../../../config/logger"),currentBeagleBoneDate=moment(),savedLastScheduledRebootDate=moment(rebootSchedulerSettings.lastScheduledRebootDate),rebootIntervalInMonth=12,rebootSettingsPath=config.rebootScheduler.rebootSettingsPath,rebootMonth=rebootSchedulerSettings.rebootMonth,reboot=!1;"dev"===process.env.NODE_ENV&&(https.globalAgent.options.rejectUnauthorized=!1);var Reboot=function(){logger.transports.file.level="info",_.bindAll(this)};Reboot.prototype.run=function(){currentBeagleBoneDate.year()<savedLastScheduledRebootDate.year()||fs.existsSync(config.updater.lockPath)||(rebootMonth!==currentBeagleBoneDate.month()||this._hasAlreadyPlannedReboot()||(logger.info("RebootScheduler: Reboot caused by selected reboot month"),reboot=!0),currentBeagleBoneDate.subtract(rebootIntervalInMonth,"months")>savedLastScheduledRebootDate&&(logger.info("RebootScheduler: Last Reboot is ",rebootIntervalInMonth," month ago"),reboot=!0),reboot&&(logger.info("RebootScheduler: System going down for a reboot"),rebootSchedulerSettings.lastScheduledRebootDate=moment().format(),fs.writeFileSync(rebootSettingsPath,JSON.stringify(rebootSchedulerSettings),"UTF8",function(a){return a?void logger.error("RebootScheduler: Aborted reboot: Could not write into ",rebootSettingsPath,a):void 0}),exec("/sbin/reboot",function(a,b){a&&logger.error("RebootScheduler: Error on trying to reboot",a,b)})))},Reboot.prototype._hasAlreadyPlannedReboot=function(){return rebootMonth===savedLastScheduledRebootDate.month()},module.exports=Reboot;