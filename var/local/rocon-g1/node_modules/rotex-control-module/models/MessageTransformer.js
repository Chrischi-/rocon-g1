var _=require("underscore"),_str=require("underscore.string"),assert=require("assert"),crc32=require("crc32"),moment=require("moment"),MessageTransformer=function(a){_.bindAll(this);var b=this;this._getter={},this._setter={},this._answer={};var c=function(a,b){return a.concat([parseInt(b.byteHigh),parseInt(b.byteLow)]).join("-")};_.each(a.findBy(),function(a){b._getter[c(a.deviceGetter,a.infoNumber)]=a,b._setter[c(a.deviceSetter,a.infoNumber)]=a,b._answer[c(a.deviceAnswer,a.infoNumber)]=a})};MessageTransformer.prototype.toParameter=function(a){var b=[a.id,a.data[0],a.data[1],a.data[2],a.data[3],a.data[4]].join("-"),c=null,d=null,e=null;return _.has(this._getter,b)?(c=this._getter[b],d="get"):_.has(this._setter,b)?(c=this._setter[b],d="set"):_.has(this._answer,b)&&(c=this._answer[b],d="answer",e=this._generateValue(a,c)),c?{parameter:c,type:d,value:e}:null},MessageTransformer.prototype.toGetMessage=function(a){var b={data:[]};return b.id=a.deviceGetter[0],b.data=a.deviceGetter.slice(1,4),b.data=b.data.concat([a.infoNumber.byteHigh,a.infoNumber.byteLow]),b.data=b.data.concat([0,0]),b},MessageTransformer.prototype.toSetMessage=function(a,b){var c={data:[]};return c.id=a.deviceSetter[0],c.data=a.deviceSetter.slice(1,4),c.data=c.data.concat([a.infoNumber.byteHigh,a.infoNumber.byteLow]),c.data=c.data.concat(this._generateMessageValue(a,b)),c},MessageTransformer.prototype._generateMessageValue=function(a,b){var c="0000";if("bool"==a.type)c="true"==b?"0001":"0000";else if("float"==a.type)c=parseFloat(b),c*=a.factor,c=c.toString(16),c=_str.pad(c,4,"0");else if("int"==a.type||"enum"==a.type)c=parseInt(b),c=c.toString(16),c=_str.pad(c,4,"0");else if("timeRange"==a.type)if("00:00-00:00"==b)c="8080";else{var d=b.split("-");c=_str.pad(this._get15Minutes(d[0]).toString(16),2,"0")+_str.pad(this._get15Minutes(d[1]).toString(16),2,"0")}var e=a.bigEndian?"0x"+c.substr(2,2):"0x"+c.substr(0,2),f=a.bigEndian?"0x"+c.substr(0,2):"0x"+c.substr(2,2);return[parseInt(e),parseInt(f)]},MessageTransformer.prototype._get15Minutes=function(a){var b=a.split(":");return 4*b[0]+b[1]/15},MessageTransformer.prototype._generateValue=function(a,b){var c=null;if(c=b.bigEndian?parseInt(a.data[6]).toString(16)+_str.pad(parseInt(a.data[5]).toString(16),2,"0"):parseInt(a.data[5]).toString(16)+_str.pad(parseInt(a.data[6]).toString(16),2,"0"),c=parseInt(c,16),32768==c)c=null;else if("float"==b.type)c>32768&&(c-=65536),c/=parseInt(b.factor),c=c.toFixed(1);else if("bool"==b.type)c=1==c?"true":"false";else if("timeRange"==b.type)if(128==a.data[5])c="00:00-00:00";else{var d=parseInt(a.data[5]),e=parseInt(a.data[6]),f=moment([2013,1,1,0,0,0,0]).add("minutes",15*d);if(96==e)c=f.format("HH:mm")+"-24:00";else{var g=moment([2013,1,1,0,0,0,0]).add("minutes",15*e);c=f.format("HH:mm")+"-"+g.format("HH:mm")}}else"intint"==b.type&&(c=[a.data[5],a.data[6]]);return c},module.exports=MessageTransformer;