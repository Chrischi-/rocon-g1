"use strict";var _=require("underscore"),_str=require("underscore.string"),assert=require("assert"),crc32=require("crc32"),ParameterModel=require("./ParameterModel.js"),ParameterRepository=function(a){assert(a);var b=this;this._parameters=[],this._cache={};var c=a.heatGenerators.concat(a.heatingCircuits.concat(a.heatingCircuitModules));_.each(c,function(c){_.each(a.parameters,function(a){var d=b._generateHash(c,a),e=new ParameterModel(a);e.hash=d,e.device=c.name,e.deviceGetter=_.map(c.get,function(a){return parseInt(a)}),e.deviceSetter=_.map(c.set,function(a){return parseInt(a)}),e.deviceAnswer=_.map(c.answer,function(a){return parseInt(a)}),e.infoNumber.byteHigh=parseInt(e.infoNumber.byteHigh),e.infoNumber.byteLow=parseInt(e.infoNumber.byteLow),e.bigEndian="true"==a.bigEndian,e.display="false"!=a.display,e.writeable="true"==a.writeable,e.waterCircuit="true"==a.waterCircuit,e["default"]=_.isUndefined(a["default"])?null:a["default"],e.min&&(e.min=parseInt(e.min)),e.max&&(e.max=parseInt(e.max)),b._parameters.push(e)})});var d=_.pluck(this._parameters,"hash"),e={};_.each(d,function(a){return _.has(e,a)?(console.log("duplicate "+b.findOneBy({hash:a}).name),void assert(!1)):void(e[a]=1)})};ParameterRepository.prototype.findBy=function(a){if(_.isEmpty(a))return this._parameters;var b=this._createKey(a);if(_.has(this._cache,b))return this._cache[b];var c=this._filterNested(this._parameters,a);return this._cache[b]=c,c},ParameterRepository.prototype._createKey=function(a){return _.map(_.keys(a),function(b){var c=_str.slugify(JSON.stringify(a[b]));return b+"-"+c}).join("-")},ParameterRepository.prototype.findOneBy=function(a){var b=this.findBy(a);return b.length>0?b[0]:null},ParameterRepository.prototype._generateHash=function(a,b){return crc32([parseInt(a.answer[0]),parseInt(a.answer[1]),parseInt(a.answer[2]),parseInt(a.answer[3]),parseInt(b.infoNumber.byteHigh),parseInt(b.infoNumber.byteLow)].join("-"))},ParameterRepository.prototype._filterNested=function(a,b){function c(a,b){var d=!0;return _.each(b,function(e,f){d&&b.hasOwnProperty(f)&&(_.has(a,f)?_.isObject(a[f])?d=c(a[f],e):a[f]!==e&&(d=!1):d=!1)}),d}return _.filter(a,function(a){return c(a,b)})},module.exports=ParameterRepository;