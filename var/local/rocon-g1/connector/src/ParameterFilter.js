var _=require("underscore"),moment=require("moment"),LoggerInformation=require("../../logging/LoggerInformation.js"),logger=require("../../config/logger"),CACHE_PARAMETERS=["cSOFTWARE_NUMMER"],ParameterFilter=function(){_.bindAll(this);var a=new LoggerInformation;a.isLoggingActivated()===!0&&(logger.transports.file.level="info"),this._valueCache={}};ParameterFilter.prototype.work=function(a,b){if(this._ignoreSoftwareParameters(a)||null==a.value)logger.debug("ParameterFilter: parameter ",a.parameter.name,"value",a.value,"has been filtered out"),b(null,null);else{var c=a.parameter,d=a.value,e=this._requestCachedValue(c,d),f=this._isAlreadyInCache(c,d,e);f?(logger.debug("ParameterFilter: parameter (Type: answer) ",a.parameter.name,"value",a.value,"has been filtered out"),b(null,null)):(logger.debug("ParameterFilter: parameter (Type: answer) ",a.parameter.name,"value",a.value,"has changed. Updating Cache"),this._updateCache(c,d),b(null,a))}},ParameterFilter.prototype._requestCachedValue=function(a){var b=null;return this._isCached(a)&&(b=this._getCached(a).value),b},ParameterFilter.prototype._isAlreadyInCache=function(a,b,c){var d=!1;if(null===c)return!1;if("float"==a.type&&a.transferThreshold){var e=parseFloat(c),f=parseFloat(b);d=a.transferThreshold>Math.abs(e-f)}if(!d&&a.transferDelay){var g=parseInt(a.transferDelay),h=!0;if(a.delayedByValue){var i=a.delayedByValue;h=_.contains(i,b),c!=b?this._updateCache(a,b):d=!0}if(h){var j=moment(),k=moment(this._valueCache[a.hash].cachedSince),l=j.diff(k,"minutes");d=g>l}}else d||(d=c==b);return d},ParameterFilter.prototype._updateCache=function(a,b){this._valueCache[a.hash]={value:b,cachedSince:new Date}},ParameterFilter.prototype._isCached=function(a){return _.has(this._valueCache,a.hash)},ParameterFilter.prototype._getCached=function(a){return this._valueCache[a.hash]},ParameterFilter.prototype._ignoreSoftwareParameters=function(a){return"answer"!=a.type&&-1===CACHE_PARAMETERS.indexOf(a.parameter.name)},module.exports=ParameterFilter;