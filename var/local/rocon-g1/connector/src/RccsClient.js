var _=require("underscore"),async=require("async"),config=require("../../config/config"),crypto=require("crypto"),https=require(config.protocol),md5=require("MD5"),moment=require("moment"),sha1=require("sha1"),LoggerInformation=require("../../logging/LoggerInformation.js"),logger=require("../../config/logger"),cMINUTE="cMINUTE",RccsClient=function(a,b,c,d,e){_.bindAll(this);var f=new LoggerInformation;f.isLoggingActivated()===!0&&(logger.transports.file.level="info"),this._beagle=a,this._socket=b,this._canFacade=c,this._parameterRepository=d,this._parameterValidator=e,this._package={},this._parameterUpdateQueue=async.queue(this._handleParameterUpdate),this._sendPackage();var g=this;a.getId(function(a,b){g.beagleId=b})};RccsClient.prototype.connect=function(){var a=this;logger.info("RccsClient: connecting start"),this._socket.on("connect",function(){async.parallel({id:a._beagle.getId,secret:a._beagle.getSecret},function(b,c){return b?void logger.error("RccsClient: Error on getting beagleId and Secret: ",b):void a._socket.emit("subscribe",{channel:"installation/"+c.id,secret:sha1(a._socket.io.engine.id+c.secret)})})}),this._socket.on("ParameterUpdate",function(b){_.each(b,function(b){a._parameterUpdateQueue.push(b)})})},RccsClient.prototype.work=function(a,b){_.isNull(a)||(this._package[a.parameter.hash]={value:a.value,name:a.parameter.name}),b(null,a)},RccsClient.prototype.request=function(a,b,c){b.path=config.rccs.path+b.path,this._sign(a,b,function(b,d){var e=https.request(d,c);a&&e.write(a),e.on("error",function(a){a&&(logger.error("RccsClient: Error on sign request statusCode 906: ",a),c({statusCode:906}))}),e.end()})},RccsClient.prototype._handleParameterUpdate=function(a,b){var c=this,d=this._parameterRepository.findOneBy({hash:a.p}),e=a.v;this._parameterValidator.validate(d,e,function(a){a?c._canFacade.send(d,e,b):(logger.info("RccsClient: Invalid Parameter; ",d,"with Value: ",e),b())})},RccsClient.prototype._createPackage=function(){var a={},b=[],c=_.map(this._package,function(a,b){return{id:a.name,value:a.value,hashvalue:b}});return c.length<=1&&(a=_.filter(c,function(a){return a.id!==cMINUTE?a:void 0})),void 0===a||0===a.length?(this._package=_.extend(c,this._package),[]):b=_.map(this._package,function(a,b){return{id:b,value:a.value}})},RccsClient.prototype._sendPackage=function(){var a=this,b=this._createPackage(),c=this._package;if(this._package={},0===b.length||!this.beagleId)return void setTimeout(this._sendPackage,1e3);var d=JSON.stringify({installation:this.beagleId,parameters:b});this.request(d,{method:"POST",path:"/installation/parameter"},function(b){200!=b.statusCode?(logger.info("RccsClient: Received StatusCode: ",b.statusCode,"on POST Request for /installation/parameter"),a._package=_.extend(c,a._package)):a._package=_.omit(a._package,_.keys(c)),setTimeout(a._sendPackage,1e3)})},RccsClient.prototype._sign=function(a,b,c){var d={hostname:config.rccs.host,port:config.rccs.port,headers:{"content-type":"application/json","content-md5":md5(a),date:moment().utc().format("ddd, DD MMM YYYY HH:mm:ss ZZ")}};b=_.extend(d,b),async.parallel({key:this._beagle.getId,secret:this._beagle.getSecret},function(d,e){if(d)return logger.error("RccsClient: Error on getting beagleId and Secret: ",d),c(d);var f=crypto.createHmac("sha512",e.key);f.update(e.secret),f.update(b.headers.date),f.update(a),b.headers["authorization-key"]=e.key,b.headers["authorization-digest"]=f.digest("hex"),c(null,b)})},module.exports=RccsClient;