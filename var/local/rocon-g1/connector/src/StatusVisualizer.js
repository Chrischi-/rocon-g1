var _=require("underscore"),assert=require("assert"),config=require("../../config/config.js"),fs=require("fs"),https=require(config.protocol),os=require("os"),flashOn=!0,StatusVisualizer=function(a,b,c,d,e){assert(a),assert(b),assert(c),assert(d),assert(e),this._colorPins=e,this._bonescript=d;var f=this;_.bindAll(this),"dev"!=process.env.NODE_ENV&&_.each(f._colorPins,function(a){d.pinMode(a,d.OUTPUT)}),this._priority=["secret","updater","dhcp","internet","can"],this._colors={updater:[f._colorPins.red,f._colorPins.blue],secret:[f._colorPins.green,f._colorPins.blue],dhcp:[f._colorPins.green,f._colorPins.red],internet:[f._colorPins.red],can:[f._colorPins.blue]},this._status={},_.each(this._priority,function(a){f._status[a]="down"}),this._initUpdateListener(),this._initSecretListener(c),this._initDhcpListener(),this._initCanListener(b),this._initSocketListener(a)};StatusVisualizer.prototype.start=function(){this.timer=setInterval(this._refreshLed,500)},StatusVisualizer.prototype.stop=function(){clearInterval(this.timer)},StatusVisualizer.prototype.setStatus=function(a,b){this._status[a]!==b&&(this._status[a]=b,console.log(a,": ",b))},StatusVisualizer.prototype.setUp=function(a){this.setStatus(a,"up")},StatusVisualizer.prototype.setDown=function(a){this.setStatus(a,"down")},StatusVisualizer.prototype._initDhcpListener=function(){var a=this;setInterval(function(){var b=os.networkInterfaces();b.eth0&&(_.any(b.eth0,function(a){return a.address.match(/\d*\.\d*\.\d*\.\d*/)})||_.any(b.eth0,function(a){return a.address.match(/\w*::\w*:\w*:\w*:\w*/)}))?a.setUp("dhcp"):a.setDown("dhcp")},5e3)},StatusVisualizer.prototype._initUpdateListener=function(){var a=this;fs.exists(config.updater.lockPath,function(b){b?a.setDown("updater"):a.setUp("updater"),setTimeout(function(){a._initUpdateListener()},config.updater.checkInterval)})},StatusVisualizer.prototype._initSecretListener=function(a){var b=this;a.getSecret(function(a,c){c?b.setUp("secret"):b.setDown("secret")})},StatusVisualizer.prototype._initRequestListener=function(){var a=this,b=https.request;https.request=function(c,d){return a._activatePins([a._colorPins.red,a._colorPins.green,a._colorPins.blue]),b.call(this,c,d)}},StatusVisualizer.prototype._initCanListener=function(a){var b=this;a.addListener("onMessage",function(){b.setUp("can"),clearTimeout(b.canTimeout),b.canTimeout=setTimeout(function(){b.setDown("can")},config.can.inactivityTimeout)})},StatusVisualizer.prototype._initSocketListener=function(a){var b=this;a.on("connect",function(){b.setUp("internet")}),a.on("error",function(){b.setDown("internet")}),a.on("disconnect",function(){b.setDown("internet")})},StatusVisualizer.prototype._refreshLed=function(){var a=this._getDownService(),b=this._getActiveColorPins(a);a&&flashOn?(this._activatePins([]),flashOn=!1):a&&!flashOn?(this._activatePins(b),flashOn=!0):this._activatePins(b)},StatusVisualizer.prototype._getDownService=function(){var a=this;return _.find(this._priority,function(b){return"down"==a._status[b]})},StatusVisualizer.prototype._getActiveColorPins=function(a){return a?this._colors[a]:[this._colorPins.green]},StatusVisualizer.prototype._activatePins=function(a){if("dev"!=process.env.NODE_ENV){var b=this;_.each(_.without(b._colorPins,a),function(a){b._bonescript.digitalWrite(a,b._bonescript.LOW)}),_.each(a,function(a){b._bonescript.digitalWrite(a,b._bonescript.HIGH)})}},module.exports=StatusVisualizer;