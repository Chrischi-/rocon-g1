"use strict";var _=require("underscore"),_str=require("underscore.string"),assert=require("assert"),fs=require("fs"),moment=require("moment"),ExportController=function(a,b){assert(b),_.bindAll(this),this._eventEmitter=a,this._parameterExporter=b,this._tickCounter=0;var c=this;this._eventEmitter.on("Refresher.Ticked",function(a){c._tickCounter=a})};ExportController.prototype.get=function(a,b){var c={day:moment().date(),month:moment().month()+1,year:moment().year(),hour:moment().hour(),minute:moment().minute()};b.render("export",{exportReady:this._tickCounter>0,currentDate:c})},ExportController.prototype.exportToJson=function(a,b){var c=this,d={};a.body.additionalInformation&&a.body.additionalInformation.length>0&&(d.additionalInformation=_str.slugify(a.body.additionalInformation)),d.installationDate=c._parseDateTime(a),this._tickCounter>0?c._sendJson(b,d):this._eventEmitter.once("Refresher.Ticked",function(){c._sendJson(b,d)})},ExportController.prototype.importFromJson=function(a,b){var c=this,d=a.files.importJson;d?fs.readFile(d.path,"utf8",function(d,e){var f=JSON.parse(e),g=c._parseDateTime(a);c._parameterExporter.importAll(f,g,function(c){c&&a.flash("error",c),b.redirect("/web/export")})}):b.redirect("/web/export")},ExportController.prototype._sendJson=function(a,b){var c=this;c._parameterExporter.exportAll(function(c,d){var e="[export-config_]";b.additionalInformation&&(e+="["+b.additionalInformation+"_]"),e+="YYYY-MM-DD[_]HH-mm-ss[.json]",a.attachment(moment(b.installationDate).format(e)),a.setHeader("Content-Type","application/octet-stream"),a.json(d)})},ExportController.prototype._parseDateTime=function(a){var b=null;return b=a.body.useClientTime?moment():moment({day:parseInt(a.body.day,10),month:parseInt(a.body.month,10)-1,year:parseInt(a.body.year,10),hour:parseInt(a.body.hour,10),minute:parseInt(a.body.minute,10)})},module.exports=ExportController;