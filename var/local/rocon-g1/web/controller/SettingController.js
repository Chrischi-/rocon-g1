var _=require("underscore"),directTemplate=require("../views/api/setting.direct.js"),heatingTemplate=require("../views/api/setting.heating.js"),printf=require("printf"),waterTemplate=require("../views/api/setting.water.js"),SettingController=function(a,b,c,d){_.bindAll(this),this._valueCache=a,this._parameterRepository=b,this._canFacade=c,this._validator=d};SettingController.prototype.list=function(a,b){var c=a.params.device,d={};"water"==c?d=this._fillTemplate(waterTemplate,"HG1"):"direct"==c?d=this._fillTemplate(directTemplate,"HG1"):-1!=c.indexOf("HC")&&(d=this._fillTemplate(heatingTemplate,c)),b.json(d)},SettingController.prototype.put=function(a,b){var c,d=this,e=a.params.device;-1!=e.indexOf("HC")?c=heatingTemplate:"water"==e?c=waterTemplate:"direct"==e&&(c=directTemplate),c||b.send(404,"unknown device"),_.each(_.keys(a.body),function(b){var f=d._parameterRepository.findOneBy({device:e,name:c[b]}),g=a.body[b];d._validator.validate(f,g,function(c){f&&c&&d._canFacade.send(f,a.body[b])})}),b.send(200)},SettingController.prototype._fillTemplate=function(a,b){var c=this,d={};return _.each(_.keys(a),function(e){d[e]=c._getValue(b,a[e]),null==d[e]&&(d[e]=c._getDate(b,a[e]))}),d},SettingController.prototype._getDate=function(a,b){var c=this._getValue(a,b+"_TAG",null),d=this._getValue(a,b+"_MONAT",null),e=this._getValue(a,b+"_JAHR",null);return c&&d&&e?printf("20%02d-%02d-%02d",e,d,c):void 0},SettingController.prototype._getValue=function(a,b){var c=this._parameterRepository.findBy({device:a,name:b});return 0==c.length?void 0:this._valueCache.get(c[0],null)},module.exports=SettingController;